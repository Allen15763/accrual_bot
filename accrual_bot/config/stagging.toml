[paths]
ref_path_mob = "accrual_bot/config/ref.xlsx"
ref_path_spt = "accrual_bot/config/ref_SPTTW.xlsx"
log_path = "./logs"
colab_zip = "/content/drive/Shareddrives/INT_TWN_SEA_FN_Shared_Resources/15_FBA/Allen/accrual_bot.zip"

[general]
pt_YM = '''(\d{4}\/(0[1-9]|1[0-2])(\s|$))'''
pt_YMD = '''(\d{4}\/(0[1-9]|1[0-2])\/((0[1-9])|(1[0-9])|(2[0-9])|(3[0-1]))(\s|$))'''
pt_YMtoYM = '''(\d{4}\/(0[1-9]|1[0-2])[-]\d{4}\/(0[1-9]|1[0-2])(\s|$))'''
pt_YMDtoYMD = '''(\d{4}\/(0[1-9]|1[0-2])\/((0[1-9])|(1[0-9])|(2[0-9])|(3[0-1]))[-]\d{4}\/(0[1-9]|1[0-2])\/((0[1-9])|(1[0-9])|(2[0-9])|(3[0-1]))(\s|$))'''

[date_patterns]
DATE_YMD_TO_YMD = '(\d{4}/\d{2}/\d{2})\s*-\s*(\d{4}/\d{2}/\d{2})'
DATE_YM_TO_YM = '(\d{4}/\d{2})\s*-\s*(\d{4}/\d{2})'
DATE_YMD = '(\d{4}/\d{2}/\d{2})'
DATE_YM = '(\d{4}/\d{2})'

# ============================================================================
# Pipeline Configuration - Configuration-driven step loading
# ============================================================================

[pipeline.spt]
enabled_po_steps = [
    "SPTDataLoading",
    "ProductFilter",
    "ColumnAddition",
    "APInvoiceIntegration",
    "PreviousWorkpaperIntegration",
    "ProcurementIntegration",
    "CommissionDataUpdate",
    "PayrollDetection",
    "DateLogic",
    "SPTERMLogic",
    "SPTStatusLabel",
    "SPTAccountPrediction",
    "SPTPostProcessing",
    "SPTExport",
]
enabled_pr_steps = [
    "SPTPRDataLoading",
    "ProductFilter",
    "ColumnAddition",
    "PreviousWorkpaperIntegration",
    "ProcurementIntegration",
    "CommissionDataUpdate",
    "PayrollDetection",
    "DateLogic",
    "SPXPRERMLogic",
    "SPTStatusLabel",
    "SPTAccountPrediction",
    "SPTPostProcessing",
    "SPTExport",
]
enabled_procurement_po_steps = [
    "SPTProcurementDataLoading",
    "ColumnInitialization",
    "ProcurementPreviousMapping",
    "DateLogic",
    "SPTProcurementStatusEvaluation",
    "SPTProcurementExport",
]
enabled_procurement_pr_steps = [
    "SPTProcurementPRDataLoading",
    "ColumnInitialization",
    "ProcurementPreviousMapping",
    "DateLogic",
    "SPTProcurementStatusEvaluation",
    "SPTProcurementExport",
]
enabled_procurement_combined_steps = [
    "CombinedProcurementDataLoading",
    "ProcurementPreviousValidation",
    "CombinedProcurementProcessing",
    "CombinedProcurementExport",
]

[pipeline.spx]
enabled_po_steps = [
    "SPXDataLoading",
    "ProductFilter",
    "ColumnAddition",
    "APInvoiceIntegration",
    "PreviousWorkpaperIntegration",
    "ProcurementIntegration",
    "DateLogic",
    "ClosingListIntegration",
    "StatusStage1",
    "SPXERMLogic",
    "ValidationDataProcessing",
    "DepositStatusUpdate",
    "DataReformatting",
    "SPXExport"
]
enabled_pr_steps = [
    "SPXPRDataLoading",
    "ProductFilter",
    "ColumnAddition",
    "PreviousWorkpaperIntegration",
    "ProcurementIntegration",
    "DateLogic",
    "ClosingListIntegration",
    "StatusStage1",
    "SPXPRERMLogic",
    "PRDataReformatting",
    "SPXPRExport"
]

[category_patterns_by_desc]
# --- 新增與調整的分類 ---
"Management Fee" = '管理費'
"Employee Welfare" = '(?i)^(?!.*Postage and Courier).*(?:Welfare|體檢)'
"Equipment Rental" = '(?i)租賃費|租賃第|月租費|事務機租賃'
"IT Hardware" = '(?i)IT - EE - FS|cisco|meraki'
"Transportation Fees" = '(?i)^(?!.*Travel).*(?:etag|紅單|ticket|car rent|租車)'
"Printing & Stationery" = '(?i)^(?!.*Postage and Courier).*(?:Printing and Stationery|影印|計張|事務機耗材|stationery|tape|膠帶|文宣)'
"Legal/Consulting Fees" = '(?i)^(?!.*Travel).*(?:legal consultant|公證)'
"Change" = '找零金'
"Locker" = '智取櫃'
"Kiosk Payment" = '(?i)^(?!.*(?:找零金|租賃))(?=.*繳費機)(?=.*payment).*'

# --- 原有的分類 ---
"Deposit" = '(?i)deposit|押金設算息|押金'
"Rental" = '(?i)rental|租金'
"Logistics" = '(?i)^(?!.*(?:安裝運費|櫃體運費)).*(?:logistics|shipping fee|運費|運什費|物流袋|物流籠車|roller container)'
"Salary & Agency Fee" = '(?i)salary|agency fee'
"Utilities" = '(?i)^(?!.*Supplies).*(?:水費|電費|internet|telephone|telecom|飲水|Utilities|Electricity)'
# 排除 "Travel" 的維修費用
"Repair & Maintenance" = '(?i)^(?!.*Travel).*(?:維修|修繕|工程|cleaning|維護保養)'
"Supplies" = '(?i)supplies|consumables|equipment|mouse|battery|pda|cctv|pallet|硬體|hardware|手工具|標示'
"Travel Expense" = '(?i)Travel Exp.'
"Insurance" = '(?i)insurance|保險'
"Postage & Courier" = '(?i)postage and courier|郵資'
# 將服務費放在較後面，避免攔截掉更具體的項目
"Service Fee" = '(?i)service fee|服務費|service charge'

[mob]
pr_pivot_index = [
    "PR#", "Project", "Supplier", "Account code_variable", 
    "Account Name_variable", "Product code._variable", 
    "Region_c_variable", "Dep._variable", "Item Description"
]
po_pivot_index = [
    "PO#", "Project", "Supplier", "Account code_variable", 
    "Account Name_variable", "Product code._variable", 
    "Region_c_variable", "Dep._variable", "Item Description"
]
sm_cr_pivot_cols = ["Liability_variable", "Product Code"]
ga_cr_pivot_cols = ["Liability_variable", "Account Name_variable"]
pivot_value_col = "Accr. Amount_variable"

[spt]
pr_pivot_index = [
    "Account code_variable", "Account Name_variable", "Supplier", 
    "PR#", "Project", "Product code._variable", 
    "Region_c_variable", "Dep._variable"
]
po_pivot_index = [
    "Account code_variable", "Account Name_variable", "Supplier", 
    "PO#", "Project", "Product code._variable", 
    "Region_c_variable", "Dep._variable"
]
sm_cr_pivot_cols = [
    "Account code_variable", "Account Name_variable", 
    "Supplier", "Liability_variable"
]
ga_cr_pivot_cols = [
    "Account code_variable", "Account Name_variable", "Liability_variable"
]
pivot_value_col = "Accr. Amount_variable"


# SPT狀態標籤標記規則配置
[spt_status_label_rules]

# 優先於ERM的條件（強制覆蓋PO狀態和Remarked by FN）
[spt_status_label_rules.priority_conditions]

# Blaire 相關條件
blaire_ssp = { keywords = '(?i)SSP', field = 'Item Description', status = '不估計(Blaire)', remark = 'Blaire', note = 'Item Description包含SSP' }
blaire_logistics_fee = { keywords = '(?i)Logistics fee|Logistic fee', field = 'Item Description', status = '不估計(Blaire)', remark = 'Blaire', note = 'Item Description包含Logistics fee或Logistic fee' }
blaire_handling_fee = { keywords = '(?i)Handling fee', field = 'Item Description', status = '不估計(Blaire)', remark = 'Blaire', note = 'Item Description包含Handling fee' }
blaire_remittance_fee = { keywords = '(?i)Remittance fee', field = 'Item Description', status = '不估計(Blaire)', remark = 'Blaire', note = 'Item Description包含Remittance fee' }
blaire_shipping_fee = { keywords = '(?i)shipping fee|逆物流運費', field = 'Item Description', status = '不估計(Blaire)', remark = 'Blaire', note = 'Item Description包含shipping fee、逆物流運費' }
blaire_hidden_code_fee = { keywords = '物流隱碼費|隱碼費|補標費', field = 'Item Description', status = '不估計(Blaire)', remark = 'Blaire', note = 'Item Description包含隱碼費、補標費' }
blaire_commissions = { keywords = '(?i)Commissions', field = 'Item Description', status = '不估計(Blaire)', remark = 'Blaire', note = 'Item Description包含Commissions' }
blaire_seller_affiliate = { keywords = '(?i)Seller affiliate', field = 'Item Description', status = '不估計(Blaire)', remark = 'Blaire', note = 'Item Description包含Seller affiliate' }
blaire_refund = { keywords = '(?i)refund', field = 'Item Description', status = '不估計(Blaire)', remark = 'Blaire', note = 'Item Description包含refund' }
blaire_service_charges = { keywords = '(?i)service charges', field = 'Item Description', status = '不估計(Blaire)', remark = 'Blaire', note = 'Item Description包含service charges' }
blaire_tradewan_non_g21 = { dept_exclude_prefix = 'G21', supplier = 'TW_關貿網路股份有限公司', status = '不估計(Blaire)', remark = 'Blaire', note = 'Department不是G21開頭且Supplier為關貿' }

# Shirley 相關條件
shirley_telecom = { dept = 'G44 - Corporate IT (BE)', keywords = '電信費|通信費|月租費|通話費|簡訊|行動上網', field = 'Item Description', status = '不估計(Shirley)', remark = 'Shirley', note = 'G44部門的電信相關費用' }

# Cindy 相關條件
cindy_ctbc = { supplier = 'TW_中國信託商業銀行股份有限公司', status = '不估計(Cindy)', remark = 'Cindy', note = 'Supplier為中國信託' }
cindy_to_confirm = { requester = 'Sherry Wu (吳欣怡)', dept = 'S01 - Marketing & Publishing', status = '待確認(Cindy)', remark = 'Cindy', note = 'Requester為Sherry Wu且部門為S01' }

# Hosting 相關條件
hosting_twnfixnet = { requester = 'Chen Hung I (陳虹沂)', dept = 'G42 - Corporate Infrastructure', supplier = 'TW_台灣固網股份有限公司', status = '不估計(Hosting)', remark = 'Hosting', note = 'Requester為陳虹沂且部門為G42且Supplier為台灣固網' }

# Michael 相關條件
michael_welfare = { supplier = 'TW_新加坡商蝦皮娛樂電商有限公司台灣分公司聯合職工福利委員會', keywords = '(?i)Employee welfare fund', field = 'Item Description', status = '不估計(Michael)', remark = 'Michael', note = 'Supplier為福委會且Item Description包含Employee welfare fund' }
michael_cobranded_card = { supplier = 'TW_國泰世華商業銀行信用卡作業部', keywords = '(?i)Co-Branded Card Campaign Fee 聯名卡', field = 'Item Description', status = '不估計(Michael)', remark = 'Michael', note = 'Supplier為國泰世華且Item Description包含聯名卡' }

# 租金相關條件
rent_global_life = { supplier = 'TW_全球人壽保險股份有限公司', keywords = '辦公室租', field = 'Item Description', status = '不估計(租金)', remark = '租金', note = 'Supplier為全球人壽且Item Description包含辦公室租' }
rent_taipei_wenchuang = { supplier = 'TW_臺北文創開發股份有限公司', keywords = '辦公室租', field = 'Item Description', status = '不估計(租金)', remark = '租金', note = 'Supplier為臺北文創且Item Description包含辦公室租' }
rent_united_daily = { supplier = 'TW_聯合報股份有限公司', keywords = '(?i)office rental fee|deposit', field = 'Item Description', status = '不估計(租金)', remark = '租金', note = 'Supplier為聯合報且Item Description包含office rental fee/deposit' }

# POST ERM(更新PO狀態)

# ERM判斷狀態包含「Description Period is out of ERM」且採購備註等於「已完成」
exceed_period_but_pq_confirmed = { status_value_contains = '(?i)error\(Description Period is out of ERM\)', remarked_by_procurement = '已完成', status = '已完成(exceed period but pq confirmed)',  note = 'ERM不在摘要的時間區間內但採購備註等於「已完成」'}
# 原本判斷Check收貨的項目且採購備註已完成。(可能前端沒上系統驗收或部分驗收)
check_qty_and_pq_confirmed = { status_value_contains = '(?i)Check收貨', remarked_by_procurement = '已完成', status = '已完成(check qty and pq confirmed)',  note = 'ERM在摘要時間區間內、ERM小於等於月結月份、Entry Qty不等於Received Qty、採購備註等於「已完成」'}
parsing_err_but_pq_confirmed = { status_value_contains = '格式錯誤，退單', remarked_by_procurement = '已完成', status = '已完成(desc parsing error but pq confirmed)',  note = '無法正確解析Item Description的時間區間但採購備註等於「已完成」'}
incomplete_but_pq_confirmed = { status_value_contains = '未完成', remarked_by_procurement = '已完成', status = '已完成(incomplete but pq confirmed)',  note = 'ERM大於月結月份且ERM在摘要時間區間內、採購備註等於「已完成」'}
hris_bug = { keywords = '(?i)卡單', field = 'Remarked by 上月 FN', status = '過往系統卡單',  note = '前期會計備註卡單'}

# ERM條件（僅更新Remarked by FN，不更新PO狀態）
[spt_status_label_rules.erm_conditions]

jianqiang_non_mkt = { dept_exclude = '(?i)Marketing', supplier = 'TW_漸強賴伯股份有限公司', remark = 'Cindy-漸強', note = 'Department不包含Marketing且Supplier為漸強' }
jianqiang_mkt = { dept_include = '(?i)S01|S02|G07', supplier = 'TW_漸強賴伯股份有限公司', remark = '漸強MKT', note = 'Department包含S01、S02、G07且Supplier為漸強' }


# ============================================================================
# SPT 會計科目規則配置
# ============================================================================
# 使用config_manager._config_toml.get('spt_account_prediction').get('rules')取得後會是一個List
# 規則按 rule_id 順序執行，每筆記錄只匹配第一個符合的條件
# 
# 規則欄位說明：
# - rule_id: 規則優先級（數字越小優先級越高）
# - account: 會計科目代碼
# - departments: 部門列表（可選，支援多個部門）
# - supplier: 供應商名稱（可選）
# - description_keywords: Item Description 關鍵字（可選，不分大小寫，多個關鍵字用 | 分隔）
# - max_amount: 金額上限（可選，Entry Amount 須小於此值）
# - condition_desc: 條件描述（顯示在 matched_conditions 欄位）
# ============================================================================

[[spt_account_prediction.rules]]
rule_id = 1
account = "450014"
departments = ["S01 - Marketing & Publishing", "S02 - Business Development (S&M)", "G07 - Project"]
description_keywords = "代收代付"
condition_desc = "Department等於以下其中之一，S01 - Marketing & Publishing、S02 - Business Development (S&M)、G07 - Project，摘要包含\"代收代付\""

[[spt_account_prediction.rules]]
rule_id = 2
account = "650050"
departments = ["S01 - Marketing & Publishing", "S02 - Business Development (S&M)", "G07 - Project"]
supplier = "TW_統一數網股份有限公司"
condition_desc = "Department等於以下其中之一，S01 - Marketing & Publishing、S02 - Business Development (S&M)、G07 - Project，且Supplier等於TW_統一數網股份有限公司"

[[spt_account_prediction.rules]]
rule_id = 3
account = "650003"
departments = ["S01 - Marketing & Publishing", "S02 - Business Development (S&M)", "G07 - Project"]
supplier = "TW_玉山銀行信用卡_dum(P)"
condition_desc = "Department等於以下其中之一，S01 - Marketing & Publishing、S02 - Business Development (S&M)、G07 - Project，且Supplier等於TW_玉山銀行信用卡_dum(P)"

[[spt_account_prediction.rules]]
rule_id = 4
account = "650003"
departments = ["S01 - Marketing & Publishing", "S02 - Business Development (S&M)", "G07 - Project"]
supplier = "TW_家品印刷有限公司"
condition_desc = "Department等於以下其中之一，S01 - Marketing & Publishing、S02 - Business Development (S&M)、G07 - Project，且Supplier等於TW_家品印刷有限公司"

[[spt_account_prediction.rules]]
rule_id = 5
account = "650003"
departments = ["S01 - Marketing & Publishing", "S02 - Business Development (S&M)", "G07 - Project"]
supplier = "TW_金玉堂彩色印刷廠股份有限公司"
condition_desc = "Department等於以下其中之一，S01 - Marketing & Publishing、S02 - Business Development (S&M)、G07 - Project，且Supplier等於TW_金玉堂彩色印刷廠股份有限公司"

[[spt_account_prediction.rules]]
rule_id = 6
account = "650003"
departments = ["S01 - Marketing & Publishing", "S02 - Business Development (S&M)", "G07 - Project"]
supplier = "TW_丸力覺醒有限公司"
condition_desc = "Department等於以下其中之一，S01 - Marketing & Publishing、S02 - Business Development (S&M)、G07 - Project，且Supplier等於TW_丸力覺醒有限公司"

[[spt_account_prediction.rules]]
rule_id = 7
account = "650019"
departments = ["S01 - Marketing & Publishing", "S02 - Business Development (S&M)", "G07 - Project"]
description_keywords = "AMS commission"
condition_desc = "Department等於以下其中之一，S01 - Marketing & Publishing、S02 - Business Development (S&M)、G07 - Project，Item Description包含\"AMS commission\""

[[spt_account_prediction.rules]]
rule_id = 8
account = "650022"
departments = ["S01 - Marketing & Publishing", "S02 - Business Development (S&M)", "G07 - Project"]
description_keywords = "Shopee commission"
condition_desc = "Department等於以下其中之一，S01 - Marketing & Publishing、S02 - Business Development (S&M)、G07 - Project，Item Description包含\"Shopee commission\""

[[spt_account_prediction.rules]]
rule_id = 9
account = "650022"
departments = ["S01 - Marketing & Publishing", "S02 - Business Development (S&M)", "G07 - Project"]
description_keywords = "AMS Campaign"
condition_desc = "Department等於以下其中之一，S01 - Marketing & Publishing、S02 - Business Development (S&M)、G07 - Project，Item Description包含\"AMS Campaign\""

[[spt_account_prediction.rules]]
rule_id = 10
account = "650003"
departments = ["S01 - Marketing & Publishing", "S02 - Business Development (S&M)", "G07 - Project"]
description_keywords = "AMS KOL"
condition_desc = "Department等於以下其中之一，S01 - Marketing & Publishing、S02 - Business Development (S&M)、G07 - Project，Item Description包含\"AMS KOL\""

[[spt_account_prediction.rules]]
rule_id = 11
account = "510001"
departments = ["C01 - Operations (COR)"]
supplier = "TW_詮力科技股份有限公司"
description_keywords = "SMS expense"
condition_desc = "Department等於C01 - Operations (COR)，Supplier等於TW_詮力科技股份有限公司，且Item Description包含\"SMS expense\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 12
account = "112002"
departments = ["G03 - People (G&A)"]
supplier = "TW_聯合大於大樓管理委員會"
description_keywords = "SCT"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_聯合大於大樓管理委員會，且Item Description包含\"SCT\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 13
account = "600301"
departments = ["G03 - People (G&A)"]
description_keywords = "Welfare Medical Fee"
condition_desc = "Department等於G03 - People (G&A)，且Item Description包含\"Welfare Medical Fee\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 14
account = "600301"
departments = ["G03 - People (G&A)"]
description_keywords = "EAP"
condition_desc = "Department等於G03 - People (G&A)，且Item Description包含\"EAP\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 15
account = "610206"
departments = ["G03 - People (G&A)"]
supplier = "TW_青晨盆景藝術苑"
description_keywords = " Plants Service Fee"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_青晨盆景藝術苑，且Item Description包含\" Plants Service Fee\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 16
account = "610206"
departments = ["G03 - People (G&A)"]
supplier = "TW_怡和祥企業有限公司"
description_keywords = " 咖啡機牛奶發泡器清洗劑"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_怡和祥企業有限公司，且Item Description包含\" 咖啡機牛奶發泡器清洗劑\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 17
account = "610102"
departments = ["G03 - People (G&A)"]
supplier = "TW_華生水資源生技股份有限公司"
description_keywords = " 辦公室飲用水"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_華生水資源生技股份有限公司，且Item Description包含\" 辦公室飲用水\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 18
account = "610206"
departments = ["G03 - People (G&A)"]
supplier = "TW_永大除蟲企業有限公司"
description_keywords = " 消毒作業 "
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_永大除蟲企業有限公司，且Item Description包含\" 消毒作業 \"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 19
account = "600311"
departments = ["G03 - People (G&A)"]
description_keywords = "Document_application"
condition_desc = "Department等於G03 - People (G&A)，且Item Description包含\"Document_application\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 20
account = "610105"
departments = ["C02 - Customer Service (COR)"]
supplier = "TW_NTT Singapore Pte. Ltd."
condition_desc = "Department等於C02 - Customer Service (COR)，Supplier等於TW_NTT Singapore Pte. Ltd."

[[spt_account_prediction.rules]]
rule_id = 21
account = "600305"
departments = ["G03 - People (G&A)"]
supplier = "TW_欣亞美容儀器材料行"
description_keywords = "按摩床巾|拋棄式床單"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_欣亞美容儀器材料行，且Item Description包含\"按摩床巾\"或\"拋棄式床單\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 22
account = "610101"
departments = ["G03 - People (G&A)"]
supplier = "TW_旭良文具印刷有限公司"
description_keywords = "name cards"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_旭良文具印刷有限公司，且Item Description包含\"name cards\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 23
account = "610101"
departments = ["G03 - People (G&A)"]
supplier = "TW_洋美環境維護股份有限公司"
description_keywords = "垃圾袋"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_洋美環境維護股份有限公司，且Item Description包含\"垃圾袋\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 24
account = "610206"
departments = ["G03 - People (G&A)"]
supplier = "TW_洋美環境維護股份有限公司"
description_keywords = "Cleaning service fee"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_洋美環境維護股份有限公司，且Item Description包含\"Cleaning service fee\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 25
account = "610104"
departments = ["G03 - People (G&A)"]
supplier = "TW_良程科技有限公司"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_良程科技有限公司"

[[spt_account_prediction.rules]]
rule_id = 26
account = "610103"
departments = ["G03 - People (G&A)"]
supplier = "TW_統一速達股份有限公司第１０６１營業區"
description_keywords = "郵資"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_統一速達股份有限公司第１０６１營業區，且Item Description包含\"郵資\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 27
account = "610103"
departments = ["G03 - People (G&A)"]
supplier = "TW_全球商務科技股份有限公司"
description_keywords = "快遞"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_全球商務科技股份有限公司，且Item Description包含\"快遞\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 28
account = "610103"
departments = ["G03 - People (G&A)"]
supplier = "TW_中華郵政股份有限公司台北光華郵局"
description_keywords = "郵資"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_中華郵政股份有限公司台北光華郵局，且Item Description包含\"郵資\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 29
account = "610201"
departments = ["G03 - People (G&A)"]
supplier = "TW_台灣歐力士股份有限公司"
description_keywords = "事務機租賃費 Copy machine|影印機 Copy machine"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_台灣歐力士股份有限公司，且Item Description包含\"事務機租賃費 Copy machine\"或\"影印機 Copy machine\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 30
account = "610104"
departments = ["G03 - People (G&A)"]
supplier = "TW_台灣歐力士股份有限公司"
description_keywords = "事務機影印費 Printing|影印費 Printer"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_台灣歐力士股份有限公司，且Item Description包含\"事務機影印費 Printing\"或\"影印費 Printer\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 31
account = "610206"
departments = ["G03 - People (G&A)"]
supplier = "TW_松潔環境維護股份有限公司"
description_keywords = "Cleaning service fee"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_松潔環境維護股份有限公司，且Item Description包含\"Cleaning service fee\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 32
account = "610101"
departments = ["G03 - People (G&A)"]
supplier = "TW_松潔環境維護股份有限公司"
description_keywords = "洗手乳|垃圾袋|洗碗精"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_松潔環境維護股份有限公司，且Item Description包含\"洗手乳\"或\"垃圾袋\"或\"洗碗精\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 33
account = "610206"
departments = ["G03 - People (G&A)"]
supplier = "TW_晶城環保服務有限公司"
description_keywords = "Cleaning fee"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_晶城環保服務有限公司，且Item Description包含\"Cleaning fee\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 34
account = "610215"
departments = ["G03 - People (G&A)"]
supplier = "TW_信威物流有限公司"
description_keywords = "Storage Rental"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_信威物流有限公司，且Item Description包含\"Storage Rental\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 35
account = "610215"
departments = ["G03 - People (G&A)"]
supplier = "TW_新得利倉儲股份有限公司"
description_keywords = "Storage Rental"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_新得利倉儲股份有限公司，且Item Description包含\"Storage Rental\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 36
account = "610206"
departments = ["G03 - People (G&A)"]
supplier = "TW_惠國科技股份有限公司"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_惠國科技股份有限公司"

[[spt_account_prediction.rules]]
rule_id = 37
account = "610206"
departments = ["G03 - People (G&A)"]
supplier = "TW_賀眾企業股份有限公司"
description_keywords = "水質檢測"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_賀眾企業股份有限公司，且Item Description包含\"水質檢測\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 38
account = "610206"
departments = ["G03 - People (G&A)"]
supplier = "TW_承開空調工程有限公司"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_承開空調工程有限公司"

[[spt_account_prediction.rules]]
rule_id = 39
account = "660201"
supplier = "TW_采江互動科技股份有限公司"
description_keywords = "Chatbot Trainer Outsourced Labour & Services"
condition_desc = "Supplier等於TW_采江互動科技股份有限公司，且Item Description包含\"Chatbot Trainer Outsourced Labour & Services\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 40
account = "530030"
supplier = "TW_程高資訊服務股份有限公司"
description_keywords = "Outsourced Labour & Services"
condition_desc = "Supplier等於TW_程高資訊服務股份有限公司，且Item Description包含\"Outsourced Labour & Services\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 41
account = "610206"
departments = ["G03 - People (G&A)"]
supplier = "TW_聖筑室內裝修設計工程有限公司"
description_keywords = "檢測|修繕|自動門異音|地毯費用"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_聖筑室內裝修設計工程有限公司，且Item Description包含\"檢測\"或\"修繕\"或\"自動門異音\"或\"地毯費用\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 42
account = "610214"
departments = ["G03 - People (G&A)"]
supplier = "TW_聖筑室內裝修設計工程有限公司"
description_keywords = "貼紙|天花板板材|油漆"
max_amount = 30000
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_聖筑室內裝修設計工程有限公司，且Item Description包含\"貼紙\"或\"天花板板材\"或\"油漆\"(不分大小寫)，且Entry Amount小於30,000"

[[spt_account_prediction.rules]]
rule_id = 43
account = "610303"
departments = ["G03 - People (G&A)"]
supplier = "TW_聖筑室內裝修設計工程有限公司"
description_keywords = "折合桌"
max_amount = 30000
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_聖筑室內裝修設計工程有限公司，且Item Description包含\"折合桌\"(不分大小寫)，且Entry Amount小於30,000"

[[spt_account_prediction.rules]]
rule_id = 44
account = "610206"
departments = ["G03 - People (G&A)"]
supplier = "TW_三泰電器股份有限公司"
description_keywords = "故障|維修|更換|修繕"
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_三泰電器股份有限公司，且Item Description包含\"故障\"或\"維修\"或\"更換\"或\"修繕\"(不分大小寫)"

[[spt_account_prediction.rules]]
rule_id = 45
account = "610303"
departments = ["G03 - People (G&A)"]
supplier = "TW_三泰電器股份有限公司"
description_keywords = "微波爐|電視|投影機"
max_amount = 30000
condition_desc = "Department等於G03 - People (G&A)，Supplier等於TW_三泰電器股份有限公司，且Item Description包含\"微波爐\"或\"電視\"或\"投影機\"(不分大小寫)，且Entry Amount小於30,000"


[spx]
ap_columns = [
    "Company", "Period", "Vendor Name", "Invoice Number", 
    "Invoice Amount", "PO_LINE_NUMBER", "PO Number", 
    "Receipt Number", "Match Type"
]
pr_ga_pivot_index = [
    "Account code", "Account Name", "Supplier", "PR#", 
    "Project", "Product code", "Region_c", "Dep."
]
pr_sm_pivot_index = [
    "Account code", "Supplier", "Account Name", 
    "PR#", "Product code", "Dep."
]
po_pivot_index = [
    "Account code", "Account Name", "Supplier", "PO#", 
    "Project", "Product code.1", "Region_c", "Dep."
]
sm_cr_pivot_cols = ["Account code", "Account Name", "Project", "Liability"]
ga_cr_pivot_cols = ["Account code", "Account Name", "Liability"]
pivot_value_col = "Accr. Amount"
exp_accounts = [650005, 650001, 610104, 630001, 650003, 610105, 620008, 600310, 610110, 620003]
bao_supplier = ["TW_寶倉物流股份有限公司", "TW_新技術供應鏈與物流股份有限公司"]
bao_categories = ["Cost of Logistics and Warehouse - Water", "Cost of Logistics and Warehouse - Electricity"]
deposit_keywords = '''(?i)押金|保證金|Deposit|找零金|定存'''
deposit_keywords_label = "摘要內有押金/保證金/Deposit/找零金"
utility_suppliers = "台灣電力|自來水|遠傳電信|中華電信|台灣大哥大|新世紀資通"
ops_for_rent = ["Angel Li (李佳宣)", "Zoey Li (李涵郁)", "Mike Zhong (鍾明賢)", "Emily Hsu (許毓淩)"]
ops_for_intermediary = "Kei Chen (陳謹婷)"
ops_for_other = "Judy Hsu (許淳方)"
account_rent = 520036
kiosk_suppliers = ["TW_立保科技股份有限公司", "TW_博辰科技股份有限公司"]
locker_suppliers = [
    "TW_台灣松下銷售股份有限公司", 
    "TW_皇丞創新科技股份有限公司", 
    "TW_華經科技股份有限公司",
    "TW_博辰科技股份有限公司"
]
locker_columns = [
    "discount", "PO單號", "廠商", "門市", "地址", "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K",
    "DA", "控制系統", "XA", "XB", "XC", "XD", "XE", "XF", "XA30", "XC30", "XG", "超出櫃體安裝費", "超出櫃體運費", "裝運費", 
    "進場月份", "驗收月份", "是否申請產編貼紙", "運費PO單號", "尾款月份"
]
locker_agg_columns = [
    "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "DA", "控制系統", "XA", "XB", "XC", "XD", "XE", "XF", "XA30", "XC30", "XG",
    "超出櫃體安裝費", "超出櫃體運費", "裝運費"
]
locker_priority_order = [
    "DA", "控制系統", "裝運費", "超出櫃體安裝費", "超出櫃體運費",
    "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K",
    "XA", "XB", "XC", "XD", "XE", "XF", "XA30", "XC30", "XG"]
expanded_contract_wb = "1psPmhZGixonVo6iX4SLhA2V4HM38iPbYN4BeFNs7WSM"
expanded_contract_range = "A:Q"
expanded_contract_range1 = "A:Y"
expanded_contract_sheet1 = "archived_contract(第一期最新合約)"
expanded_contract_sheet2 = "第二期續約案件"
expanded_contract_sheet3 = "第三期續約案件"
contract_filing_list_sheet = "歸檔清單"
contract_filing_list_range = "D,H,P"
key_for_merging_origin_and_renew_contract = ["sp_code", "address"]

output_columns_before_nlp = [
    "po_link","po_number","po_submitter",
    "po_submitter_email","region","department",
    "po_supplier", "pr_requester","description","currency",
    "po_total_amount","po_total_amount_usd","pr_number",
    "po_status", "total_invoice_amount","last_action_date",
    "expected_receive_month", "pia","category",
    "product_code","rgn","gl_number",
    "item_description","unit_price","entry_quantity",
    "received_quantity","billed_quantity","prepay_quantity",
    "entry_amount","entry_billed_amount","entry_prepay_amount",
    "po_entry_status","是否結案",
    "結案是否有差異數量","check_with_entry_invoice","pr_line",
    "po_line","remarked_by_procurement","noted_by_procurement",
    "remarked_by_procurement_pr","noted_by_procurement_pr","remarked_by_上月_fn",
    "remarked_by_上月_fn_pr","noted_by_fn","remarked_by_上月_procurement",
    "previ_liability",
    "po狀態","remarked_by_fn","是否估計入帳",
    "是否為fa","是否為s&m","account_code",
    "account_name","product_code_c","region_c",
    "dep.","currency_c","accr._amount",
    "liability","是否有預付","累計至上期驗收數量/金額",
    "本期驗收數量/金額","累計至本期驗收數量/金額","gl_date",
    "match_type","category_from_desc",
    "predicted_account","matched_keyword","裝修一般/分期",
    "matched_condition_on_status",
    "question_from_reviewer","check_by_ap",
]

output_columns_before_nlp_pr = [
    "pr_link","pr_number","requester",
    "region","department","pr_supplier",
    "description","currency","total_amount",
    "last_action_date","expected_receive_month","pia",
    "category","product_code","rgn",
    "gl_number","item_description","unit_price",
    "entry_quantity","entry_amount","po_number",
    "是否結案","結案是否有差異數量","check_with_entry_invoice",
    "pr_line","remarked_by_procurement","noted_by_procurement",
    "remarked_by_fn","remarked_by_上月_fn","noted_by_fn",
    "remarked_by_上月_procurement", "pr狀態","是否估計入帳",
    "是否為fa","是否為s&m","account_code",
    "account_name","product_code_c","region_c",
    "dep.","currency_c","accr._amount",
    "liability","是否有預付","gl_date",
    "category_from_desc","predicted_account","matched_keyword",
    "matched_condition_on_status",
    "question_from_reviewer","check_by_ap",
]

dw_suppliers = [
    "TW_寶倉物流股份有限公司",
    "TW_新技術供應鏈與物流股份有限公司",
    "TW_全勝國際企業股份有限公司",
    "TW_新財企業股份有限公司",
    "TW_湧昱有限公司",
    "TW_鑫志勝股份有限公司",
    "TW_長榮國際儲運股份有限公司",
    "TW_勤德股份有限公司",
    "TW_茗嘉鼎實業股份有限公司",
    "TW_佳輝鍛造有限公司",
    "TW_輝庭企業股份有限公司",
    "TW_澤宇國際企業股份有限公司",
]


[fa_accounts]
mob = [199999, 530016, 610303]
spt = [199999]
spx = [199999]

[logging]
level = "INFO"
format = "%(asctime)s %(levelname)s: %(message)s"

[credentials]
certificate_path = "./secret/credentials.json"
scopes = ["https://www.googleapis.com/auth/spreadsheets.readonly"]

# 會計科目與關鍵字的對應規則
[account_rules]
"199999" = '路由器\(Router\)|交換器|門市裝修工程|門市招牌安裝工程|冷氣裝修工程|門市智取櫃工程|門市繳費機訂金|門市繳費機交機款|門市繳費機尾款|IT - Computer'
"520012" = '繳費機租賃費|印表機租金|事務機租賃|Water dispenser rental|事務機移機|印表機租賃費|Wooden Pallet Rental Fee'
"520013" = '\^Leased\^'  # 注意: TOML 中反斜線需要轉義，所以 \^ 變成 \\^
"520014" = 'Cleaning fee|消毒|removal fee|保全服務費|防治|封鈔袋|收補鈔服務費|weeding fee|垃圾清運|Rodent control|Disinfection|保全警衛服務費|清運費|清理化糞池'
"520016" = '文具用品|Office Stationery|stationery and consumables|生活用品|營運用品|paper|PDA Gungrip|PDA LCD Protector|除塵拖及地墊租賃|mop rental|Cleaning utensil rental|夾鏈袋|垃圾袋|門市事務機耗材費|護貝膜|租賃手持拖把|租賃拖把|SOC Daily necessities|手套|rental mop|除塵撢'
"520017" = 'tape|膠帶|退貨組_|物流袋|膠膜|PE單片|carton|破壞袋'
"520018" = '門市室內標示|intermediary fee|貼紙|政府審查規費Interior Decoration application fee|感熱紙捲|室內標示|SPX制服|合格安全鞋|保護貼|門市室裝申請|消防檢修申報|建築物安檢申報'
"520019" = 'PDA|滅火器工程|Office Hardware|門市斜坡架|APP新安裝|監視器工程|Guardrail equipment|CCTV|門市貨架增設|門市寄件設備零件|門市智慧監控直立主機|門市智慧監控授權卡片|門市智慧監控硬碟|Hardware accessories|備品採購|平板車|延長線|Type-C HUB|籠車|RFID Card|Receipt Printer|Barcode Scanner|Printer Cutter|U-Type adapter|固定式掃馬槍|物流箱+卡片夾|Plastic pallet|手工具採購|傳輸線|Pallet Shipping Fee|IT - CRO - Gechic|電池|驗收專案款'
"520025" = '倉庫管理費|Management expenses|倉_園區管理費'
"520026" = '維護費|關轉工程|保養工程|維修|撤櫃|智取店撤除|APP 其他檢修|退租撤店工程|監視器改善工程|Repair|replacement|maintenance|更換飲水濾心|復裝費用|驗水費|門市小圓招|閉店工程'
"520028" = 'Bottled water|桶裝水'
"520029" = '保險'
"520030" = 'Warehouse Temp Salary|派車費用'
"520033" = 'Stacker|pallet truck|Stacker rental|堆高機'
"520036" = '管理費'
"520037" = 'Shopee Xpress Temp'
"600301" = 'Employee Welfare Medical Fee'
"610103" = '郵資'
"610104" = '計張費|paper usage fee'
"610105" = 'APP 人數上限擴充|後臺人數擴充'
"610110" = 'SPX門市發票代傳至財政部及營業稅申報檔相關服務'
"630001" = 'Dispatcher fare'
"650005" = 'shipping fee|Logistics Fee'

# ============================================================================
# Previous Workpaper Integration Configuration
# ============================================================================

[previous_workpaper_integration]
# 前期底稿整合步驟的配置

[previous_workpaper_integration.column_patterns]
# 欄位名稱的正則表達式模式 (支援大小寫不敏感)
po_line = '(?i)^(po[_\s]?line)$'
pr_line = '(?i)^(pr[_\s]?line)$'
remarked_by_fn = '(?i)^(remarked[_\s]?by[_\s]?fn)$'
remarked_by_procurement = '(?i)^(remarked?[_\s]?by[_\s]?(procurement|pr[_\s]?team))$'
noted_by_fn = '(?i)^(noted[_\s]?by[_\s]?fn)$'
noted_by_procurement = '(?i)^(noted[_\s]?by[_\s]?(procurement|pr))$'
liability = '(?i)^(liability)$'
current_month_reviewed_by = '(?i)^(current[_\s]?month[_\s]?reviewed[_\s]?by)$'
cumulative_qty = '(?i)^(累計至本期驗收數量/金額)$'

[previous_workpaper_integration.po_mappings]
# PO 前期底稿欄位映射配置
# 格式: {source = "來源欄位", target = "目標欄位", fill_na = true/false}

[[previous_workpaper_integration.po_mappings.fields]]
source = "remarked_by_fn"
target = "Remarked by 上月 FN"
fill_na = true
description = "前期 FN 備註"

[[previous_workpaper_integration.po_mappings.fields]]
source = "remarked_by_procurement"
target = "Remarked by 上月 Procurement"
fill_na = true
description = "前期採購備註"

[[previous_workpaper_integration.po_mappings.fields]]
source = "累計至本期驗收數量/金額"
target = "累計至本期驗收數量/金額"
fill_na = true
description = "累計至本期驗收數量/金額 (for PPE - SPX)"

[[previous_workpaper_integration.po_mappings.fields]]
source = "noted_by_fn"
target = "Noted by FN"
fill_na = true
description = "特殊會計備註"

# 新增欄位範例：liability 映射
[[previous_workpaper_integration.po_mappings.fields]]
source = "liability"
target = "previ_Liability"
fill_na = true
description = "負債科目"
entities = ["SPX"]  # 僅限 SPX，空陣列或省略entities表示所有 Entity 套用

[previous_workpaper_integration.pr_mappings]
# PR 前期底稿欄位映射配置

[[previous_workpaper_integration.pr_mappings.fields]]
source = "remarked_by_fn"
target = "Remarked by 上月 FN PR"
fill_na = true
description = "前期 PR FN 備註"

[[previous_workpaper_integration.pr_mappings.fields]]
source = "noted_by_fn"
target = "Noted by FN"
fill_na = false
description = "特殊會計備註 (PR 可覆蓋 PO 的值)"

[previous_workpaper_integration.reviewer_mapping]
# Reviewer 資訊映射配置 (僅限 SPT)
enabled_entities = ["SPT"]
source = "current_month_reviewed_by"
targets = ["previous_month_reviewed_by", "current_month_reviewed_by"]
description = "從前期底稿取回 Reviewer 資訊"


# =============================================================================
# 採購前期底稿映射配置 (參考 previous_workpaper_integration 模式)
# =============================================================================
[spt_procurement_previous_mapping]
# 欄位名稱正則模式
[spt_procurement_previous_mapping.column_patterns]
po_line = '(?i)^(po[_\s]?line)$'
pr_line = '(?i)^(pr[_\s]?line)$'
remarked_by_procurement = '(?i)^(remarked?[_\s]?by[_\s]?(procurement|pq))$'

# PO 映射配置
[[spt_procurement_previous_mapping.po_mappings.fields]]
source = "remarked_by_procurement"
target = "prev_remarked_procurement"
fill_na = true
description = "前期採購備註"

# PR 映射配置
[[spt_procurement_previous_mapping.pr_mappings.fields]]
source = "remarked_by_procurement"
target = "prev_remarked_procurement"
fill_na = true
description = "前期採購備註"


# =============================================================================
# 採購狀態判斷規則 - 完全配置驅動
# =============================================================================
# 條件類型說明:
#   - contains: 欄位包含指定模式 (正則)
#   - equals: 欄位等於指定值
#   - not_equals: 欄位不等於指定值
#   - erm_in_range: ERM 在 Item Description 日期範圍內
#   - erm_le_closing: ERM ≤ 結帳月
#   - erm_gt_closing: ERM > 結帳月
#
# combine 說明:
#   - and: 所有條件皆需滿足
#   - or: 任一條件滿足即可
# =============================================================================

[[spt_procurement_status_rules.conditions]]
priority = 1
status_value = "需求取消"
note = "前期備註為需求取消|close|關單"
[[spt_procurement_status_rules.conditions.checks]]
field = "prev_remarked_procurement"
type = "contains"
pattern = "(?i)需求取消|close|關單"

[[spt_procurement_status_rules.conditions]]
priority = 2
status_value = "前期已完成"
note = "前期採購備註為已完成"
[[spt_procurement_status_rules.conditions.checks]]
field = "prev_remarked_procurement"
type = "equals"
value = "已完成"

[[spt_procurement_status_rules.conditions]]
priority = 3
status_value = "Affiliate"
note = "Item Description 包含 Affiliate 或 分潤"
[[spt_procurement_status_rules.conditions.checks]]
field = "Item Description"
type = "contains"
pattern = "(?i)affiliate|分潤"

[[spt_procurement_status_rules.conditions]]
priority = 4
status_value = "勞報"
note = "Item Description 包含 AMS commission、Shopee commission、LiveStream and KOL"
[[spt_procurement_status_rules.conditions.checks]]
field = "Item Description"
type = "contains"
pattern = "(?i)AMS\\s+commission|Shopee\\s+commission|(?=.*livestream)(?=.*kol)"

[[spt_procurement_status_rules.conditions]]
priority = 5
status_value = "FN Payroll"
note = "Item Description 包含 Employee Bonus"
[[spt_procurement_status_rules.conditions.checks]]
field = "Item Description"
type = "contains"
pattern = "(?i)employee\\s*bonus"

[[spt_procurement_status_rules.conditions]]
priority = 6
status_value = "FN Payroll"
note = "Supplier是勤業眾信"
[[spt_procurement_status_rules.conditions.checks]]
field = "Supplier"
type = "contains"
pattern = "勤業眾信"

[[spt_procurement_status_rules.conditions]]
priority = 7
status_value = "Svp Rental"
note = "Item Description 同時包含 SVP 和 租金/rent"
combine = "and"
[[spt_procurement_status_rules.conditions.checks]]
field = "Item Description"
type = "contains"
pattern = "(?i)svp"
[[spt_procurement_status_rules.conditions.checks]]
field = "Item Description"
type = "contains"
pattern = "(?i)租金|rent"

[[spt_procurement_status_rules.conditions]]
priority = 8
status_value = "Svp Rental"
note = "Item Description 包含 ^Leased^ 的特殊格式摘要 且Supplier非聯合大於大樓|臺北文創大樓|高力國際公寓大廈"
combine = "and"
[[spt_procurement_status_rules.conditions.checks]]
field = "Item Description"
type = "contains"
pattern = "(?i)\\^Leased\\^S\\d{1}-kwh\\^|(?=.*leased)(?=.*kwh)"
[[spt_procurement_status_rules.conditions.checks]]
field = "Supplier"
type = "not_contains"
pattern = "聯合大於大樓|臺北文創大樓|高力國際公寓大廈"

[[spt_procurement_status_rules.conditions]]
priority = 9
status_value = "已完成"
note = "前期非已完成，且 ERM 在範圍內且 ≤ 結帳月"
combine = "and"
[[spt_procurement_status_rules.conditions.checks]]
field = "prev_remarked_procurement"
type = "not_equals"
value = "已完成"
[[spt_procurement_status_rules.conditions.checks]]
type = "erm_in_range"
[[spt_procurement_status_rules.conditions.checks]]
type = "erm_le_closing"
[[spt_procurement_status_rules.conditions.checks]]
field = "YMs of Item Description"
type = "not_equals"
value = "100001,100002"

[[spt_procurement_status_rules.conditions]]
priority = 10
status_value = "已完成"
note = "前期非已完成，且 ERM ≤ 結帳月"
combine = "and"
[[spt_procurement_status_rules.conditions.checks]]
field = "prev_remarked_procurement"
type = "not_equals"
value = "已完成"
[[spt_procurement_status_rules.conditions.checks]]
type = "erm_le_closing"
[[spt_procurement_status_rules.conditions.checks]]
field = "YMs of Item Description"
type = "not_equals"
value = "100001,100002"

[[spt_procurement_status_rules.conditions]]
priority = 11
status_value = "未完成"
note = "ERM 在範圍內且 > 結帳月"
combine = "and"
[[spt_procurement_status_rules.conditions.checks]]
type = "erm_in_range"
[[spt_procurement_status_rules.conditions.checks]]
type = "erm_gt_closing"
[[spt_procurement_status_rules.conditions.checks]]
field = "YMs of Item Description"
type = "not_equals"
value = "100001,100002"

[[spt_procurement_status_rules.conditions]]
priority = 12
status_value = "未完成"
note = "ERM > 結帳月"
combine = "and"
[[spt_procurement_status_rules.conditions.checks]]
type = "erm_gt_closing"
[[spt_procurement_status_rules.conditions.checks]]
field = "YMs of Item Description"
type = "not_equals"
value = "100001,100002"

[[spt_procurement_status_rules.conditions]]
priority = 13
status_value = "格式錯誤"
note = "非標準格式，解析摘要區間失敗"
combine = "and"
[[spt_procurement_status_rules.conditions.checks]]
field = "YMs of Item Description"
type = "equals"
value = "100001,100002"
[[spt_procurement_status_rules.conditions.checks]]
field = "prev_remarked_procurement"
type = "not_equals"
value = "已完成"


# =============================================================================
# SPX 硬編碼常數值配置
# =============================================================================
[spx_column_defaults]
region = "TW"
default_department = "000"
prepay_liability = "111112"
sm_accounts = ["650003", "450014"]
validation_account_name = "AP,FA Clear Account"
validation_liability = "200414"


# =============================================================================
# SPX 第一階段狀態標籤規則 - 配置驅動
# =============================================================================
# 條件按 priority 順序執行，先匹配的優先
# 數據驅動的條件（關單清單比對、FA備註提取）保留程式碼，此處僅配置可配置化的規則
#
# apply_to: ["PO"], ["PR"], 或 ["PO", "PR"] 表示適用的處理類型
# combine: "and"（預設，所有 checks 皆需滿足）或 "or"（任一滿足）
#
# check type 說明:
#   - contains / not_contains: 欄位包含/不包含正則模式
#   - equals / not_equals: 欄位等於/不等於值
#   - in_list / not_in_list: 欄位在/不在列表中
#   - is_not_null / is_null: 欄位非空/為空
#   - no_status: 狀態欄位為空或 'nan'
#   - erm_le_date / erm_gt_date: ERM <= / > processing_date
#   - erm_in_range: ERM 在摘要日期區間內
#   - out_of_range: ERM 不在摘要區間且非格式錯誤
#   - desc_erm_le_date / desc_erm_gt_date: 摘要月份 <= / > processing_date
#   - desc_erm_not_error: 摘要月份 != 100001
#   - qty_matched / qty_not_matched: Entry Qty == / != Received Qty
#   - not_billed / has_billing / fully_billed / has_unpaid: 帳務條件
#   - format_error: 摘要日期 == '100001,100002'
#   - remark_completed: Procurement/FN 備註包含已完成/rent
#   - pr_not_incomplete: 上月FN PR 備註不包含未完成
#   - not_error: Procurement 備註 != 'error'
#   - is_fa / not_fa: GL# 在/不在 FA 科目清單
#
# pattern_key / value_key / list_key: 引用 stagging.toml 其他區段的值
#   例如 pattern_key = "spx.deposit_keywords" 引用 [spx] 區段的 deposit_keywords
# =============================================================================

# --- 找零金識別 ---
[[spx_status_stage1_rules.conditions]]
priority = 1
status_value = "門市找零金"
apply_to = ["PO", "PR"]
note = "供應商為立保找零金且Item Description包含找零，GL#非FA科目(199999)"
combine = "and"
[[spx_status_stage1_rules.conditions.checks]]
field = "{TYPE} Supplier"
type = "equals"
value_key = "TW_立保保全股份有限公司－找零金"
[[spx_status_stage1_rules.conditions.checks]]
field = "Item Description"
type = "contains"
pattern = "(?i)找零"
[[spx_status_stage1_rules.conditions.checks]]
field = "GL#"
type = "not_equals"
value_key = "fa_accounts.spx"

# --- 倉庫押金識別 ---
[[spx_status_stage1_rules.conditions]]
priority = 2
status_value = "倉庫押金"
apply_to = ["PO", "PR"]
note = "供應商為倉庫系列且Item Description包含押金|保證金，GL#非FA科目(199999)"
combine = "and"
[[spx_status_stage1_rules.conditions.checks]]
field = "{TYPE} Supplier"
type = "in_list"
list_key = "spx.dw_suppliers"
[[spx_status_stage1_rules.conditions.checks]]
field = "Item Description"
type = "contains"
pattern = "押金|保證金"
[[spx_status_stage1_rules.conditions.checks]]
field = "GL#"
type = "not_equals"
value_key = "fa_accounts.spx"

# --- 門市押金識別 ---
[[spx_status_stage1_rules.conditions]]
priority = 3
status_value = "門市押金"
apply_to = ["PO", "PR"]
note = "供應商為自然人(TW_xxx_ddd)且Item Description包含押金等，GL#非FA科目(199999)"
combine = "and"
[[spx_status_stage1_rules.conditions.checks]]
field = "{TYPE} Supplier"
type = "contains"
pattern = '^TW_.*_\d+$'
[[spx_status_stage1_rules.conditions.checks]]
field = "Item Description"
type = "contains"
pattern_key = "spx.deposit_keywords"
[[spx_status_stage1_rules.conditions.checks]]
field = "GL#"
type = "not_equals"
value_key = "fa_accounts.spx"

# --- 條件 : 押金/保證金識別 ---
[[spx_status_stage1_rules.conditions]]
priority = 4
status_value_key = "spx.deposit_keywords_label"
apply_to = ["PO", "PR"]
note = "Item Description包含押金/保證金/Deposit/找零金/定存，且GL#非FA科目(199999)，且排除繳費機訂金"
combine = "and"
[[spx_status_stage1_rules.conditions.checks]]
field = "Item Description"
type = "contains"
pattern_key = "spx.deposit_keywords"
[[spx_status_stage1_rules.conditions.checks]]
field = "GL#"
type = "not_equals"
value_key = "fa_accounts.spx"
[[spx_status_stage1_rules.conditions.checks]]
field = "Item Description"
type = "not_contains"
pattern = "(?i)繳費機訂金"

# --- 條件 : BAO供應商GL調整 ---
[[spx_status_stage1_rules.conditions]]
priority = 5
status_value = "GL調整"
apply_to = ["PO", "PR"]
note = "供應商為寶倉物流/新技術供應鏈且類別為水電相關倉儲成本"
combine = "and"
[[spx_status_stage1_rules.conditions.checks]]
field = "{TYPE} Supplier"
type = "in_list"
list_key = "spx.bao_supplier"
[[spx_status_stage1_rules.conditions.checks]]
field = "Category"
type = "in_list"
list_key = "spx.bao_categories"

# --- 條件 : 上月FN備註關單 ---
[[spx_status_stage1_rules.conditions]]
priority = 6
status_value = "參照上月關單"
apply_to = ["PO", "PR"]
note = "Remarked by 上月 FN 或 Remarked by 上月 FN PR 包含「刪」或「關」"
combine = "or"
[[spx_status_stage1_rules.conditions.checks]]
field = "Remarked by 上月 FN"
type = "contains"
pattern = "刪|關"
[[spx_status_stage1_rules.conditions.checks]]
field = "Remarked by 上月 FN PR"
type = "contains"
pattern = "刪|關"

# --- 條件 7: 公共費用供應商 ---
[[spx_status_stage1_rules.conditions]]
priority = 7
status_value = "授扣GL調整"
apply_to = ["PO", "PR"]
note = "供應商為台電/自來水/電信等公共費用供應商"
[[spx_status_stage1_rules.conditions.checks]]
field = "{TYPE} Supplier"
type = "contains"
pattern_key = "spx.utility_suppliers"

# --- 條件 8: 已完成_租金(ERM<=當月) ---
[[spx_status_stage1_rules.conditions]]
priority = 8
status_value = "已完成_租金(ERM<=當月租金)"
apply_to = ["PO", "PR"]
note = "尚未標籤、申請人為OPS租金人員、GL#為租金科目、ERM<=當月、摘要月<=當月"
combine = "and"
[[spx_status_stage1_rules.conditions.checks]]
type = "no_status"
[[spx_status_stage1_rules.conditions.checks]]
type = "erm_le_date"
[[spx_status_stage1_rules.conditions.checks]]
field = "GL#"
type = "equals"
value_key = "spx.account_rent"
[[spx_status_stage1_rules.conditions.checks]]
field = "{TYPE} Requester"
type = "in_list"
list_key = "spx.ops_for_rent"
[[spx_status_stage1_rules.conditions.checks]]
type = "desc_erm_le_date"

# --- 條件 9: 已完成_租金(摘要月<=當月) ---
[[spx_status_stage1_rules.conditions]]
priority = 9
status_value = "已完成_租金(摘要月<=當月租金)"
apply_to = ["PO", "PR"]
note = "尚未標籤、摘要月<=當月、GL#為租金科目、申請人為OPS租金人員、摘要月非格式錯誤"
combine = "and"
[[spx_status_stage1_rules.conditions.checks]]
type = "no_status"
[[spx_status_stage1_rules.conditions.checks]]
type = "desc_erm_le_date"
[[spx_status_stage1_rules.conditions.checks]]
field = "GL#"
type = "equals"
value_key = "spx.account_rent"
[[spx_status_stage1_rules.conditions.checks]]
field = "{TYPE} Requester"
type = "in_list"
list_key = "spx.ops_for_rent"
[[spx_status_stage1_rules.conditions.checks]]
type = "desc_erm_not_error"

# --- 條件 10: 租金已入帳 ---
# override_statuses: 允許覆蓋條件8/9產生的租金狀態
[[spx_status_stage1_rules.conditions]]
priority = 10
status_value = "已入帳"
apply_to = ["PO"]
note = "狀態為已完成_租金且GL DATE非空(已入帳)"
combine = "and"
override_statuses = ["已完成_租金(ERM<=當月租金)", "已完成_租金(摘要月<=當月租金)"]
[[spx_status_stage1_rules.conditions.checks]]
field = "PO狀態"
type = "contains"
pattern = "已完成_租金"
[[spx_status_stage1_rules.conditions.checks]]
field = "GL DATE"
type = "is_not_null"

# --- 條件 11: 未完成_租金 ---
[[spx_status_stage1_rules.conditions]]
priority = 11
status_value = "未完成_租金"
apply_to = ["PO", "PR"]
note = "採購備註非error、尚未標籤、OPS租金人員、租金科目、摘要含租金、ERM>當月且摘要日期非100001,100002"
combine = "and"
[[spx_status_stage1_rules.conditions.checks]]
type = "not_error"
[[spx_status_stage1_rules.conditions.checks]]
type = "no_status"
[[spx_status_stage1_rules.conditions.checks]]
field = "{TYPE} Requester"
type = "in_list"
list_key = "spx.ops_for_rent"
[[spx_status_stage1_rules.conditions.checks]]
field = "GL#"
type = "equals"
value_key = "spx.account_rent"
[[spx_status_stage1_rules.conditions.checks]]
field = "Item Description"
type = "contains"
pattern = "(?i)租金"
[[spx_status_stage1_rules.conditions.checks]]
type = "erm_gt_date"
[[spx_status_stage1_rules.conditions.checks]]
field = "YMs of Item Description"
type = "not_equals"
value = "100001,100002"

# --- 條件 12: 已完成_intermediary ---
[[spx_status_stage1_rules.conditions]]
priority = 12
status_value = "已完成_intermediary"
apply_to = ["PO", "PR"]
note = "尚未標籤、OPS intermediary人員、摘要含intermediary、ERM==當月或(ERM<當月且上月FN備註已完成)、沒有GL DATE"
combine = "and"
[[spx_status_stage1_rules.conditions.checks]]
type = "no_status"
[[spx_status_stage1_rules.conditions.checks]]
field = "{TYPE} Requester"
type = "equals"
value_key = "spx.ops_for_intermediary"
[[spx_status_stage1_rules.conditions.checks]]
field = "Item Description"
type = "contains"
pattern = "(?i)intermediary"
[[spx_status_stage1_rules.conditions.checks]]
type = "erm_le_date"
[[spx_status_stage1_rules.conditions.checks]]
field = "GL DATE"
type = "is_null"

# --- 條件 13: 未完成_intermediary ---
[[spx_status_stage1_rules.conditions]]
priority = 13
status_value = "未完成_intermediary"
apply_to = ["PO", "PR"]
note = "尚未標籤、OPS intermediary人員、摘要含intermediary、ERM>當月"
combine = "and"
[[spx_status_stage1_rules.conditions.checks]]
type = "no_status"
[[spx_status_stage1_rules.conditions.checks]]
field = "{TYPE} Requester"
type = "equals"
value_key = "spx.ops_for_intermediary"
[[spx_status_stage1_rules.conditions.checks]]
field = "Item Description"
type = "contains"
pattern = "(?i)intermediary"
[[spx_status_stage1_rules.conditions.checks]]
type = "erm_gt_date"

# --- 條件 14: 資產待驗收(PO) ---
[[spx_status_stage1_rules.conditions]]
priority = 14
status_value = "Pending_validating"
apply_to = ["PO"]
note = "供應商為智取櫃/繳費機供應商、不含一般入FA備註(但包含部分完成入FA)、非關單項目"
combine = "and"
[[spx_status_stage1_rules.conditions.checks]]
field = "PO Supplier"
type = "in_list"
list_key = "spx.asset_suppliers"
[[spx_status_stage1_rules.conditions.checks]]
field = "PO狀態"
type = "not_contains"
pattern = "關"

# --- 條件 15: PR智取櫃與繳費機 ---
[[spx_status_stage1_rules.conditions]]
priority = 15
status_value = "智取櫃與繳費機"
apply_to = ["PR"]
note = "PR供應商為智取櫃/繳費機供應商、非關單項目"
combine = "and"
[[spx_status_stage1_rules.conditions.checks]]
field = "PR Supplier"
type = "in_list"
list_key = "spx.asset_suppliers"
[[spx_status_stage1_rules.conditions.checks]]
field = "PR狀態"
type = "not_contains"
pattern = "關"


# =============================================================================
# SPX ERM 狀態判斷規則 - 配置驅動
# =============================================================================
# 按 priority 順序執行，每次執行後自動更新 no_status mask
# 使用 prebuilt_masks 引用預先計算的條件（如 erm_in_range, qty_matched 等）
# =============================================================================

# --- ERM 條件 1: 已入帳（前期FN標註）---
[[spx_erm_status_rules.conditions]]
priority = 1
status_value = "已入帳"
note = "前期FN備註明確標註「已入帳」"
[[spx_erm_status_rules.conditions.checks]]
field = "Remarked by 上月 FN"
type = "contains"
pattern = "(?i)已入帳"

# --- ERM 條件 2: 已入帳（GL DATE）---
[[spx_erm_status_rules.conditions]]
priority = 2
status_value = "已入帳"
note = "有GL DATE、ERM在摘要範圍內、ERM<=月結月份、收貨數量匹配、有帳務記錄、採購/FN備註已完成/rent、非FA科目"
combine = "and"
[[spx_erm_status_rules.conditions.checks]]
field = "GL DATE"
type = "is_not_null"
[[spx_erm_status_rules.conditions.checks]]
type = "no_status"
[[spx_erm_status_rules.conditions.checks]]
type = "erm_in_range"
[[spx_erm_status_rules.conditions.checks]]
type = "erm_le_date"
[[spx_erm_status_rules.conditions.checks]]
type = "qty_matched"
[[spx_erm_status_rules.conditions.checks]]
type = "has_billing"
[[spx_erm_status_rules.conditions.checks]]
type = "remark_completed"
[[spx_erm_status_rules.conditions.checks]]
type = "not_fa"

# --- ERM 條件 2.1: 已入帳（GL DATE）；排除備註跟billing amt限制---
[[spx_erm_status_rules.conditions]]
priority = 2
status_value = "已入帳"
note = "有GL DATE、ERM在摘要範圍內、ERM<=月結月份、收貨數量匹配、非FA科目"
combine = "and"
[[spx_erm_status_rules.conditions.checks]]
field = "GL DATE"
type = "is_not_null"
[[spx_erm_status_rules.conditions.checks]]
type = "no_status"
[[spx_erm_status_rules.conditions.checks]]
type = "erm_in_range"
[[spx_erm_status_rules.conditions.checks]]
type = "erm_le_date"
[[spx_erm_status_rules.conditions.checks]]
type = "qty_matched"
[[spx_erm_status_rules.conditions.checks]]
type = "not_fa"

# --- ERM 條件 3: 已完成(not_billed) ---
[[spx_erm_status_rules.conditions]]
priority = 3
status_value = "已完成(not_billed)"
note = "採購/FN備註已完成、上月FN PR非未完成、尚未標籤、ERM在範圍內、ERM<=月結、收貨匹配、未入帳(Billed Amount=0)"
combine = "and"
[[spx_erm_status_rules.conditions.checks]]
type = "remark_completed"
[[spx_erm_status_rules.conditions.checks]]
type = "pr_not_incomplete"
[[spx_erm_status_rules.conditions.checks]]
type = "no_status"
[[spx_erm_status_rules.conditions.checks]]
type = "erm_in_range"
[[spx_erm_status_rules.conditions.checks]]
type = "erm_le_date"
[[spx_erm_status_rules.conditions.checks]]
type = "qty_matched"
[[spx_erm_status_rules.conditions.checks]]
type = "not_billed"

# --- ERM 條件 4: 已完成(fully_billed) ---
[[spx_erm_status_rules.conditions]]
priority = 4
status_value = "已完成(fully_billed)"
note = "採購/FN備註已完成、尚未標籤、ERM在範圍內、ERM<=月結、收貨匹配、Billed Amount!=0、全部入帳(Amount-Billed=0)"
combine = "and"
[[spx_erm_status_rules.conditions.checks]]
type = "remark_completed"
[[spx_erm_status_rules.conditions.checks]]
type = "no_status"
[[spx_erm_status_rules.conditions.checks]]
type = "erm_in_range"
[[spx_erm_status_rules.conditions.checks]]
type = "erm_le_date"
[[spx_erm_status_rules.conditions.checks]]
type = "qty_matched"
[[spx_erm_status_rules.conditions.checks]]
field = "Entry Billed Amount"
type = "not_equals"
value = "0"
cast = "Float64"
[[spx_erm_status_rules.conditions.checks]]
type = "fully_billed"

# --- ERM 條件 5: 已完成(partially_billed) ---
[[spx_erm_status_rules.conditions]]
priority = 5
status_value = "已完成(partially_billed)"
note = "採購/FN備註已完成、尚未標籤、ERM在範圍內、ERM<=月結、收貨匹配、Billed Amount!=0、部分入帳(Amount-Billed!=0)"
combine = "and"
[[spx_erm_status_rules.conditions.checks]]
type = "remark_completed"
[[spx_erm_status_rules.conditions.checks]]
type = "no_status"
[[spx_erm_status_rules.conditions.checks]]
type = "erm_in_range"
[[spx_erm_status_rules.conditions.checks]]
type = "erm_le_date"
[[spx_erm_status_rules.conditions.checks]]
type = "qty_matched"
[[spx_erm_status_rules.conditions.checks]]
field = "Entry Billed Amount"
type = "not_equals"
value = "0"
cast = "Float64"
[[spx_erm_status_rules.conditions.checks]]
type = "has_unpaid"

# --- ERM 條件 6: Check收貨 ---
[[spx_erm_status_rules.conditions]]
priority = 6
status_value = "Check收貨"
note = "採購備註非error、尚未標籤、ERM在範圍內、ERM<=月結、收貨數量不匹配(Entry Qty!=Received Qty)"
combine = "and"
[[spx_erm_status_rules.conditions.checks]]
type = "not_error"
[[spx_erm_status_rules.conditions.checks]]
type = "no_status"
[[spx_erm_status_rules.conditions.checks]]
type = "erm_in_range"
[[spx_erm_status_rules.conditions.checks]]
type = "erm_le_date"
[[spx_erm_status_rules.conditions.checks]]
type = "qty_not_matched"

# --- ERM 條件 7: 未完成 ---
[[spx_erm_status_rules.conditions]]
priority = 7
status_value = "未完成"
note = "採購備註非error、尚未標籤、ERM在範圍內、ERM>月結月份"
combine = "and"
[[spx_erm_status_rules.conditions.checks]]
type = "not_error"
[[spx_erm_status_rules.conditions.checks]]
type = "no_status"
[[spx_erm_status_rules.conditions.checks]]
type = "erm_in_range"
[[spx_erm_status_rules.conditions.checks]]
type = "erm_gt_date"

# --- ERM 條件 8: 範圍錯誤_租金 ---
[[spx_erm_status_rules.conditions]]
priority = 8
status_value = "error(Description Period is out of ERM)_租金"
note = "採購備註非error、尚未標籤、ERM不在摘要期間內(且非格式錯誤)、摘要包含租金"
combine = "and"
[[spx_erm_status_rules.conditions.checks]]
type = "not_error"
[[spx_erm_status_rules.conditions.checks]]
type = "no_status"
[[spx_erm_status_rules.conditions.checks]]
type = "out_of_range"
[[spx_erm_status_rules.conditions.checks]]
field = "Item Description"
type = "contains"
pattern = "(?i)租金"

# --- ERM 條件 9: 範圍錯誤_薪資 ---
[[spx_erm_status_rules.conditions]]
priority = 9
status_value = "error(Description Period is out of ERM)_薪資"
note = "採購備註非error、尚未標籤、ERM不在摘要期間內(且非格式錯誤)、摘要包含派遣/Salary/Agency Fee"
combine = "and"
[[spx_erm_status_rules.conditions.checks]]
type = "not_error"
[[spx_erm_status_rules.conditions.checks]]
type = "no_status"
[[spx_erm_status_rules.conditions.checks]]
type = "out_of_range"
[[spx_erm_status_rules.conditions.checks]]
field = "Item Description"
type = "contains"
pattern = "(?i)派遣|Salary|Agency Fee"

# --- ERM 條件 10: 範圍錯誤（一般）---
[[spx_erm_status_rules.conditions]]
priority = 10
status_value = "error(Description Period is out of ERM)"
note = "採購備註非error、尚未標籤、ERM不在摘要期間內(且非格式錯誤)"
combine = "and"
[[spx_erm_status_rules.conditions.checks]]
type = "not_error"
[[spx_erm_status_rules.conditions.checks]]
type = "no_status"
[[spx_erm_status_rules.conditions.checks]]
type = "out_of_range"

# --- ERM 條件 11: 部分完成ERM ---
[[spx_erm_status_rules.conditions]]
priority = 11
status_value = "部分完成ERM"
note = "採購備註非error、尚未標籤、ERM不在摘要期間內、已有部分收貨(Received Qty!=0)、收貨不匹配"
combine = "and"
[[spx_erm_status_rules.conditions.checks]]
type = "not_error"
[[spx_erm_status_rules.conditions.checks]]
type = "no_status"
[[spx_erm_status_rules.conditions.checks]]
type = "out_of_range"
[[spx_erm_status_rules.conditions.checks]]
field = "Received Quantity"
type = "not_equals"
value = "0"
cast = "Float64"
[[spx_erm_status_rules.conditions.checks]]
type = "qty_not_matched"

# =============================================================================
# SPX PR ERM 狀態規則（配置驅動）
# 對應 SPXPRERMLogicStep 的 8 個 PR 狀態條件
#
# 與 PO 的核心差異：
# 1. 不判斷收貨狀態（無 Received Quantity 相關邏輯）
# 2. 不判斷入賬狀態（無 Billed Amount 相關邏輯）
# 3. 基於業務類型（租金/Intermediary/資產）進行判斷
# =============================================================================

# --- PR ERM 條件 1: 已入帳（前期FN標註）---
[[spx_pr_erm_status_rules.conditions]]
priority = 1
status_value = "已入帳"
note = "前期FN備註明確標註「已入帳」"
[[spx_pr_erm_status_rules.conditions.checks]]
field = "Remarked by 上月 FN"
type = "contains"
pattern = "(?i)已入帳"

# --- PR ERM 條件 2: 已完成（有採購或會計備註）---
[[spx_pr_erm_status_rules.conditions]]
priority = 2
status_value = "已完成"
note = "採購/FN備註已完成或Rent、上月FN非未完成、ERM在範圍內、ERM<=月結、採購備註非error"
combine = "and"
[[spx_pr_erm_status_rules.conditions.checks]]
type = "remark_completed"
[[spx_pr_erm_status_rules.conditions.checks]]
field = "Remarked by 上月 FN"
type = "not_contains"
pattern = "(?i)未完成"
[[spx_pr_erm_status_rules.conditions.checks]]
type = "not_error"
[[spx_pr_erm_status_rules.conditions.checks]]
type = "erm_in_range"
[[spx_pr_erm_status_rules.conditions.checks]]
type = "erm_le_date"

# --- PR ERM 條件 2-1: 已完成（沒有採購或會計備註）---
[[spx_pr_erm_status_rules.conditions]]
priority = 3
status_value = "已完成"
note = "採購備註非未完成/取消、上月FN非未完成、ERM在範圍內、ERM<=月結、採購備註非error"
combine = "and"
[[spx_pr_erm_status_rules.conditions.checks]]
field = "Remarked by Procurement"
type = "not_contains"
pattern = "(?i)未完成|取消"
[[spx_pr_erm_status_rules.conditions.checks]]
field = "Remarked by 上月 FN"
type = "not_contains"
pattern = "(?i)未完成"
[[spx_pr_erm_status_rules.conditions.checks]]
type = "not_error"
[[spx_pr_erm_status_rules.conditions.checks]]
type = "erm_in_range"
[[spx_pr_erm_status_rules.conditions.checks]]
type = "erm_le_date"

# --- PR ERM 條件 3: 未完成 ---
[[spx_pr_erm_status_rules.conditions]]
priority = 4
status_value = "未完成"
note = "採購備註非error、ERM在範圍內、ERM>月結月份"
combine = "and"
[[spx_pr_erm_status_rules.conditions.checks]]
type = "not_error"
[[spx_pr_erm_status_rules.conditions.checks]]
type = "erm_in_range"
[[spx_pr_erm_status_rules.conditions.checks]]
type = "erm_gt_date"

# --- PR ERM 條件 4: 範圍錯誤_租金 ---
[[spx_pr_erm_status_rules.conditions]]
priority = 5
status_value = "error(Description Period is out of ERM)_租金"
note = "採購備註非error、ERM不在摘要期間內、申請人為租金ops、科目為租金科目、摘要包含租金"
combine = "and"
[[spx_pr_erm_status_rules.conditions.checks]]
type = "not_error"
[[spx_pr_erm_status_rules.conditions.checks]]
type = "out_of_range"
[[spx_pr_erm_status_rules.conditions.checks]]
field = "Requester"
type = "in_list"
list_key = "spx.ops_for_rent"
[[spx_pr_erm_status_rules.conditions.checks]]
field = "GL#"
type = "equals"
value_key = "spx.account_rent"
[[spx_pr_erm_status_rules.conditions.checks]]
field = "Item Description"
type = "contains"
pattern = "(?i)租金"

# --- PR ERM 條件 5: 範圍錯誤_薪資 ---
[[spx_pr_erm_status_rules.conditions]]
priority = 6
status_value = "error(Description Period is out of ERM)_薪資"
note = "採購備註非error、ERM不在摘要期間內、摘要包含派遣/Salary/Agency Fee"
combine = "and"
[[spx_pr_erm_status_rules.conditions.checks]]
type = "not_error"
[[spx_pr_erm_status_rules.conditions.checks]]
type = "out_of_range"
[[spx_pr_erm_status_rules.conditions.checks]]
field = "Item Description"
type = "contains"
pattern = "(?i)派遣|Salary|Agency Fee"

# --- PR ERM 條件 6: 範圍錯誤（一般）---
[[spx_pr_erm_status_rules.conditions]]
priority = 7
status_value = "error(Description Period is out of ERM)"
note = "採購備註非error、ERM不在摘要期間內"
combine = "and"
[[spx_pr_erm_status_rules.conditions.checks]]
type = "not_error"
[[spx_pr_erm_status_rules.conditions.checks]]
type = "out_of_range"

# --- PR ERM 條件 7: 資產類_待確認 ---
[[spx_pr_erm_status_rules.conditions]]
priority = 8
status_value = "資產類_待確認"
note = "供應商為智取櫃或繳費機供應商"
[[spx_pr_erm_status_rules.conditions.checks]]
field = "PR Supplier"
type = "in_list"
list_key = "spx.asset_suppliers"